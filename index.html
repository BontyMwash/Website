<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STUD DTS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        input, select, button {
            margin: 5px;
        }
        table, th, td {
            border: 1px solid #000;
            border-collapse: collapse;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h2>Teacher Login</h2>
        <input type="text" id="username" placeholder="Enter Username">
        <input type="password" id="password" placeholder="Enter Password">
        <button onclick="login()">Login</button>
    </div>

    <div id="dashboard" style="display: none;">
        <h2>Welcome, <span id="teacherName"></span></h2>
        <button onclick="logout()">Logout</button>

        <h3>Select Class & Stream</h3>
        <select id="classSelect" onchange="loadStreams()">
            <option value="Form 2">Form 2</option>
            <option value="Form 3">Form 3</option>
            <option value="Form 4">Form 4</option>
        </select>
        <select id="streamSelect">
            <option value="Stream 1">Stream 1</option>
        </select>

        <h3>Manage Students</h3>
        <input type="text" id="studentName" placeholder="Student Name">
        <input type="text" id="studentID" placeholder="Student ID">
        <br><br>
        <button onclick="addStudent()">Add Student</button>
        <button onclick="removeStudent()">Remove Student</button>
        <button onclick="fetchStudents()">View Students</button>

        <h3>Student List</h3>
        <button onclick="downloadCSV()">Download Student Details</button>
        <table id="studentsTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>ID</th>
                    <th>Class</th>
                    <th>Stream</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Generate Report</h3>
        <button onclick="generateReport()">Download Report</button>
    </div>

    <script>
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzTLIue8U7tPDN9sMzUO7Gz0pYdTRLjOOLRuIpFTaJbLUM6YLgvdFtrmKl4FnfyMhyUrw/exec';

        function login() {
            const username = document.getElementById('username').value;
            if (username) {
                document.getElementById('teacherName').innerText = username;
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            } else {
                alert('Please enter a username.');
            }
        }

        function logout() {
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        function loadStreams() {
            const classValue = document.getElementById('classSelect').value;
            const streamSelect = document.getElementById('streamSelect');
            streamSelect.innerHTML = '';

            let streamCount = (classValue === 'Form 2') ? 9 : 6;

            for (let i = 1; i <= streamCount; i++) {
                const option = document.createElement('option');
                option.value = `Stream ${i}`;
                option.text = `Stream ${i}`;
                streamSelect.appendChild(option);
            }
        }

        function addStudent() {
    const name = document.getElementById("studentName").value;
    const studentID = document.getElementById("studentID").value;
    const classVal = document.getElementById("classSelect").value;
    const stream = document.getElementById("streamSelect").value;

    if (!name || !studentID) {
        alert("Please enter both Name and ID.");
        return;
    }

    const data = {
        name: name,
        studentID: studentID,
        class: classVal,
        stream: stream
    };

    fetch(SHEET_API_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(response => {
        if (response.result === 'success') {
            alert("Student added successfully!");
            fetchStudents(); // refresh list
        } else {
            alert("Failed to add student.");
        }
    })
    .catch(err => {
        console.error("Fetch Error:", err);
        alert("Network or API error.");
    });
}


        function fetchStudents() {
            fetch(SHEET_API_URL)
                .then(res => res.json())
                .then(data => {
                    const table = document.getElementById("studentsTable").getElementsByTagName("tbody")[0];
                    table.innerHTML = '';
                    data.forEach(student => {
                        const row = table.insertRow();
                        row.innerHTML = `
                            <td>${student.Name}</td>
                            <td>${student.ID}</td>
                            <td>${student.Class}</td>
                            <td>${student.Stream}</td>
                            <td>${student.Timestamp}</td>
                        `;
                    });
                })
                .catch(err => {
                    console.error("View Error:", err);
                    alert("Error fetching students.");
                });
        }

        function downloadCSV() {
            fetch(SHEET_API_URL)
                .then(res => res.json())
                .then(data => {
                    let csv = "Name,ID,Class,Stream,Timestamp\n";
                    data.forEach(row => {
                        csv += `${row.Name},${row.ID},${row.Class},${row.Stream},${row.Timestamp}\n`;
                    });

                    const blob = new Blob([csv], { type: 'text/csv' });
                    const link = document.createElement("a");
                    link.href = window.URL.createObjectURL(blob);
                    link.download = "students.csv";
                    link.click();
                })
                .catch(err => {
                    console.error("CSV Error:", err);
                });
        }

        function generateReport() {
            downloadCSV();
        }

        function removeStudent() {
            alert("Remove functionality not implemented yet.");
        }
    </script>
</body>
</html>
